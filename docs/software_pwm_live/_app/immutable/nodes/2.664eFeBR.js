import{f as Ee,a as Be}from"../chunks/DlA8RBvb.js";import{o as $e}from"../chunks/DRH7_kZM.js";import{h as I,av as me,aw as Le,u as ge,g as be,c as S,ax as We,V as Re,l as Ve,P as l,Z as p,z as Ge,X as c,A as Ne,W as Oe,ay as r,az as b,Y as u,ae as fe}from"../chunks/nGsIfouQ.js";import{d as ze,s as A}from"../chunks/BpHlLxFX.js";import{r as x}from"../chunks/dlOV9k9g.js";import{b as Ke}from"../chunks/Cl6WUn8k.js";function Fe(e,a){return e==null?null:String(e)}function pe(e,a,i,n){var o=e.__style;if(I||o!==a){var t=Fe(a);(!I||t!==e.getAttribute("style"))&&(t==null?e.removeAttribute("style"):e.style.cssText=t),e.__style=a}return n}function j(e,a,i=a){var n=new WeakSet;me(e,"input",async o=>{var t=o?e.defaultValue:e.value;if(t=q(e)?J(t):t,i(t),S!==null&&n.add(S),await Le(),t!==(t=a())){var d=e.selectionStart,h=e.selectionEnd,v=e.value.length;if(e.value=t??"",h!==null){var m=e.value.length;d===h&&h===v&&m>v?(e.selectionStart=m,e.selectionEnd=m):(e.selectionStart=d,e.selectionEnd=Math.min(h,m))}}}),(I&&e.defaultValue!==e.value||ge(a)==null&&e.value)&&(i(q(e)?J(e.value):e.value),S!==null&&n.add(S)),be(()=>{var o=a();if(e===document.activeElement){var t=We??S;if(n.has(t))return}q(e)&&o===J(e.value)||e.type==="date"&&!o&&!e.value||o!==e.value&&(e.value=o??"")})}function Ue(e,a,i=a){me(e,"change",n=>{var o=n?e.defaultChecked:e.checked;i(o)}),(I&&e.defaultChecked!==e.checked||ge(a)==null)&&i(e.checked),be(()=>{var n=a();e.checked=!!n})}function q(e){var a=e.type;return a==="number"||a==="range"}function J(e){return e===""?null:+e}class je{constructor(a,i){this.apiKey=a,this.callbacks=i,this.ws=null,this.audioContext=null,this.mediaStream=null,this.audioProcessor=null,this.nextStartTime=0,this.inputAnalyser=null,this.outputAnalyser=null,this.volumeInterval=null}async connect(){const a=`wss://generativelanguage.googleapis.com/ws/google.ai.generativelanguage.v1alpha.GenerativeService.BidiGenerateContent?key=${this.apiKey}`;this.ws=new WebSocket(a),this.ws.onopen=()=>{console.log("Connected to Gemini Live"),this.sendSetup(),this.startAudioStream(),this.callbacks.onConnect&&this.callbacks.onConnect()},this.ws.onmessage=async i=>{const n=i.data;if(n instanceof Blob){const o=await n.text(),t=JSON.parse(o);this.handleMessage(t)}else console.log("Received non-blob message:",n)},this.ws.onclose=()=>{console.log("Disconnected from Gemini Live"),this.stopAudioStream(),this.callbacks.onDisconnect&&this.callbacks.onDisconnect()},this.ws.onerror=i=>{console.error("WebSocket Error:",i),this.callbacks.onError&&this.callbacks.onError(i)}}sendSetup(){const a={setup:{model:"models/gemini-2.5-flash-native-audio-preview-12-2025",generation_config:{response_modalities:["AUDIO"],speech_config:{voice_config:{prebuilt_voice_config:{voice_name:"Charon"}}}},tools:[{function_declarations:[{name:"set_blinking",description:"Turn blinking on or off",parameters:{type:"object",properties:{enabled:{type:"boolean"}},required:["enabled"]}},{name:"set_brightness",description:"Set the brightness of the LED (0-10)",parameters:{type:"object",properties:{level:{type:"number"}},required:["level"]}},{name:"set_interval",description:"Set the blinking interval in milliseconds",parameters:{type:"object",properties:{ms:{type:"number"}},required:["ms"]}},{name:"get_status",description:"Get the current status of the Arduino",parameters:{type:"object",properties:{}}}]}]}};this.ws&&this.ws.send(JSON.stringify(a))}async startAudioStream(){const a=window.AudioContext||window.webkitAudioContext;this.audioContext=new a({sampleRate:24e3}),this.inputAnalyser=this.audioContext.createAnalyser(),this.outputAnalyser=this.audioContext.createAnalyser(),this.outputAnalyser.connect(this.audioContext.destination);try{this.mediaStream=await navigator.mediaDevices.getUserMedia({audio:!0})}catch(n){console.error("Microphone access denied",n);return}await this.audioContext.audioWorklet.addModule("data:text/javascript;base64,"+btoa(this.getAudioWorkletCode()));const i=this.audioContext.createMediaStreamSource(this.mediaStream);this.audioProcessor=new AudioWorkletNode(this.audioContext,"pcm-processor"),this.audioProcessor.port.onmessage=n=>{const o=n.data;if(this.ws&&this.ws.readyState===WebSocket.OPEN){const t=o.buffer,h={realtime_input:{media_chunks:[{mime_type:"audio/pcm;rate=24000",data:this.arrayBufferToBase64(t)}]}};this.ws.send(JSON.stringify(h))}},i.connect(this.inputAnalyser),i.connect(this.audioProcessor),this.startVolumeReporting()}stopAudioStream(){this.stopVolumeReporting(),this.mediaStream&&(this.mediaStream.getTracks().forEach(a=>a.stop()),this.mediaStream=null),this.audioProcessor&&(this.audioProcessor.disconnect(),this.audioProcessor=null),this.audioContext&&(this.audioContext.close(),this.audioContext=null),this.inputAnalyser=null,this.outputAnalyser=null}startVolumeReporting(){this.volumeInterval&&clearInterval(this.volumeInterval),this.volumeInterval=setInterval(()=>{if(this.callbacks.onVolume){const a=o=>{if(!o)return 0;const t=o.fftSize,d=new Uint8Array(t);o.getByteTimeDomainData(d);let h=0;for(let v=0;v<t;v++){const m=(d[v]-128)/128;h+=m*m}return Math.sqrt(h/t)},i=Math.min(1,a(this.inputAnalyser)*2),n=Math.min(1,a(this.outputAnalyser)*2);this.callbacks.onVolume(i,n)}},50)}stopVolumeReporting(){this.volumeInterval&&clearInterval(this.volumeInterval),this.volumeInterval=null}getAudioWorkletCode(){return`
			class PCMProcessor extends AudioWorkletProcessor {
				constructor() {
					super();
					this.bufferSize = 2048;
					this.buffer = new Float32Array(this.bufferSize);
					this.bufferIndex = 0;
				}

				process(inputs, outputs, parameters) {
					const input = inputs[0];
					if (input.length > 0) {
						const inputChannel = input[0];
						// Buffer incoming audio data
						for (let i = 0; i < inputChannel.length; i++) {
							this.buffer[this.bufferIndex++] = inputChannel[i];
							if (this.bufferIndex === this.bufferSize) {
								this.flush();
							}
						}
					}
					return true; // Keep processor alive
				}

				flush() {
					// Convert Float32 (-1.0 to 1.0) to Int16 (-32768 to 32767)
					const pcmData = new Int16Array(this.bufferSize);
					for (let i = 0; i < this.bufferSize; i++) {
						const s = Math.max(-1, Math.min(1, this.buffer[i]));
						pcmData[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
					}
					// Send data back to main thread
					this.port.postMessage(pcmData);
					this.bufferIndex = 0;
				}
			}
			registerProcessor("pcm-processor", PCMProcessor);
		`}arrayBufferToBase64(a){let i="";const n=new Uint8Array(a),o=n.byteLength;for(let t=0;t<o;t++)i+=String.fromCharCode(n[t]);return window.btoa(i)}handleMessage(a){if(a.serverContent){if(a.serverContent.modelTurn){const i=a.serverContent.modelTurn.parts;for(const n of i)n.inlineData&&n.inlineData.mimeType.startsWith("audio/pcm")&&this.playAudio(n.inlineData.data)}}else a.toolCall&&this.handleToolCall(a.toolCall)}async handleToolCall(a){const i=a.functionCalls,n=[];for(const t of i){console.log("Tool call:",t.name,t.args);let d={};this.callbacks.onToolCall&&(d=await this.callbacks.onToolCall(t.name,t.args)),d===void 0&&(d={result:"ok"}),n.push({id:t.id,name:t.name,response:{result:d}})}const o={tool_response:{function_responses:n}};this.ws&&this.ws.send(JSON.stringify(o))}playAudio(a){if(!this.audioContext)return;const i=window.atob(a),n=i.length,o=new Uint8Array(n);for(let g=0;g<n;g++)o[g]=i.charCodeAt(g);const t=new Int16Array(o.buffer),d=new Float32Array(t.length);for(let g=0;g<t.length;g++)d[g]=t[g]/32768;const h=this.audioContext.createBuffer(1,d.length,24e3);h.copyToChannel(d,0);const v=this.audioContext.createBufferSource();v.buffer=h,this.outputAnalyser?v.connect(this.outputAnalyser):v.connect(this.audioContext.destination);const m=Math.max(this.audioContext.currentTime,this.nextStartTime);v.start(m),this.nextStartTime=m+h.duration}disconnect(){this.ws&&(this.ws.close(),this.ws=null),this.stopAudioStream()}}var qe=Ee(`<h1 class="svelte-1uha8ag">Arduino Software PWM Control + Gemini Live</h1> <p class="subtitle svelte-1uha8ag">Controls the on-board LED on an Arduino UNO via Serial commands.</p> <div class="container svelte-1uha8ag"><div class="left-panel svelte-1uha8ag"><div class="control-group svelte-1uha8ag"><button class="svelte-1uha8ag">Connect Arduino</button></div> <div class="control-group gemini-box svelte-1uha8ag"><h2>Gemini Live</h2> <div class="input-row svelte-1uha8ag"><label>API Key: <input type="password" placeholder="Enter Gemini API Key" class="svelte-1uha8ag"/></label></div> <div class="status-row svelte-1uha8ag"><span> </span> <button class="svelte-1uha8ag"> </button></div> <div class="audio-levels svelte-1uha8ag"><div class="level-row svelte-1uha8ag"><span class="label">Mic</span> <div class="meter svelte-1uha8ag"><div class="fill svelte-1uha8ag"></div></div></div> <div class="level-row svelte-1uha8ag"><span class="label">Speaker</span> <div class="meter svelte-1uha8ag"><div class="fill svelte-1uha8ag"></div></div></div></div> <p class="hint svelte-1uha8ag">Try saying: "Turn on blinking", "Set brightness to 5", "Set interval to
				100ms"</p></div> <div class="control-group svelte-1uha8ag"><label><input type="checkbox"/> Blinking</label></div> <div class="control-group svelte-1uha8ag"><label> <input type="range" min="0" max="10"/></label></div> <div class="control-group svelte-1uha8ag"><label>Interval (ms): <input type="number"/></label></div> <div class="control-group svelte-1uha8ag"><button class="svelte-1uha8ag">Sync Status</button></div></div> <div class="right-panel svelte-1uha8ag"><h2 class="svelte-1uha8ag">Serial Output</h2> <pre class="svelte-1uha8ag"> </pre></div></div>`,1);function et(e,a){Re(a,!0);let i,n,o,t=b(""),d,h=b(!1),v=b(5),m=b(200),g=b(0),T=b(0),_=b(""),y=b(!1),C=null,w=b("Disconnected");$e(()=>{const s=localStorage.getItem("gemini_api_key");s&&r(_,s,!0)}),Ve(()=>{l(t),d&&(d.scrollTop=d.scrollHeight)});const _e=async()=>{try{i=await navigator.serial.requestPort(),await i.open({baudRate:9600}),o=i.writable.getWriter(),ye(),r(t,l(t)+`Connected to Arduino
`),setTimeout(M,2e3)}catch(s){r(t,l(t)+`Error: ${s.message}
`)}},ye=async()=>{try{if(!i||!i.readable)return;const s=i.readable.getReader();n=s;const f=new TextDecoder;let U="";for(;;){const{value:Pe,done:De}=await s.read();if(De)break;const he=f.decode(Pe,{stream:!0});r(t,l(t)+he),U+=he;const ve=U.split(`
`);U=ve.pop()||"",ve.forEach(we)}}catch(s){r(t,l(t)+`Error reading from serial port: ${s.message}
`)}},k=async s=>{if(!o){r(t,l(t)+`Not connected to serial
`);return}const f=new TextEncoder().encode(s+`
`);await o.write(f)},H=()=>{k(`blink=${l(h)?1:0}`)},X=()=>{k(`brightness=${l(v)}`)},Y=()=>{k(`interval=${l(m)}`)},M=()=>{k("status")},we=s=>{const f=s.match(/blink=(\d+),brightness=(\d+),interval=(\d+)/);f&&(r(h,f[1]==="1"),r(v,parseInt(f[2],10),!0),r(m,parseInt(f[3],10),!0))},Se=async()=>{if(l(y))C&&C.disconnect(),r(y,!1),r(w,"Disconnected");else{if(!l(_)){alert("Please enter a Gemini API Key");return}localStorage.setItem("gemini_api_key",l(_)),C=new je(l(_),{onConnect:()=>{r(w,"Connected"),r(y,!0)},onDisconnect:()=>{r(w,"Disconnected"),r(y,!1),r(g,0),r(T,0)},onError:s=>{r(w,`Error: ${s.message||s}`),r(y,!1)},onVolume:(s,f)=>{r(g,s,!0),r(T,f,!0)},onToolCall:async(s,f)=>{if(console.log("Tool called:",s,f),r(t,l(t)+`[Gemini] Calling ${s} with ${JSON.stringify(f)}
`),s==="set_blinking")return r(h,f.enabled,!0),H(),`Blinking set to ${l(h)}`;if(s==="set_brightness")return r(v,f.level,!0),X(),`Brightness set to ${l(v)}`;if(s==="set_interval")return r(m,f.ms,!0),Y(),`Interval set to ${l(m)}`;if(s==="get_status")return M(),"Status command sent to Arduino. Please check serial output."}}),await C.connect()}};var Z=qe(),Q=p(Ge(Z),4),P=c(Q),D=c(P),Ce=c(D);Ce.__click=_e,u(D);var E=p(D,2),B=p(c(E),2),ee=c(B),te=p(c(ee));x(te),u(ee),u(B);var $=p(B,2),L=c($),ke=c(L);u(L);var W=p(L,2);W.__click=Se;var Ae=c(W,!0);u(W),u($);var ae=p($,2),R=c(ae),se=p(c(R),2),xe=c(se);u(se),u(R);var ie=p(R,2),ne=p(c(ie),2),Ie=c(ne);u(ne),u(ie),u(ae),fe(2),u(E);var V=p(E,2),oe=c(V),G=c(oe);x(G),G.__change=H,fe(),u(oe),u(V);var N=p(V,2),re=c(N),le=c(re),O=p(le);x(O),O.__change=X,u(re),u(N);var z=p(N,2),ce=c(z),K=p(c(ce));x(K),K.__change=Y,u(ce),u(z);var ue=p(z,2),Te=c(ue);Te.__click=M,u(ue),u(P);var de=p(P,2),F=p(c(de),2),Me=c(F,!0);u(F),Ke(F,s=>d=s,()=>d),u(de),u(Q),Ne((s,f)=>{A(ke,`Status: ${l(w)??""}`),A(Ae,l(y)?"Stop Live":"Start Live"),pe(xe,`width: ${s??""}%`),pe(Ie,`width: ${f??""}%`),A(le,`Brightness: ${l(v)??""} `),A(Me,l(t))},[()=>Math.min(100,l(g)*100),()=>Math.min(100,l(T)*100)]),j(te,()=>l(_),s=>r(_,s)),Ue(G,()=>l(h),s=>r(h,s)),j(O,()=>l(v),s=>r(v,s)),j(K,()=>l(m),s=>r(m,s)),Be(e,Z),Oe()}ze(["click","change"]);export{et as component};
